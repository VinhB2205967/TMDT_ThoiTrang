extends ../../layouts/default.pug
include ../../mixins/filter_status.pug
include ../../mixins/search.pug
include ../../mixins/page.pug
block main
    - const currentFilter = filterStatus;
    .page-header-section
        .d-flex.justify-content-between.align-items-center.flex-wrap.gap-2
            h1.page-title.mb-0
                i.bi.bi-box-seam.me-2
                | Quản lý sản phẩm
            .d-flex.align-items-center.gap-3
                a.btn.btn-success(href=`${admin}/products/create`)
                    i.bi.bi-plus-lg.me-1
                    | Thêm sản phẩm
                .admin-user-menu
                .dropdown
                    button.btn.btn-light.dropdown-toggle#adminDropdown(type="button" data-bs-toggle="dropdown" aria-expanded="false")
                        i.bi.bi-person-circle.me-2
                        span Admin
                    ul.dropdown-menu.dropdown-menu-end(aria-labelledby="adminDropdown")
                        li
                            a.dropdown-item(href="#")
                                i.bi.bi-person.me-2
                                | Thông tin tài khoản
                        li
                            a.dropdown-item(href="#")
                                i.bi.bi-gear.me-2
                                | Cài đặt
                        li
                            a.dropdown-item(href="#")
                                i.bi.bi-bell.me-2
                                | Thông báo
                        li: hr.dropdown-divider
                        li
                            a.dropdown-item.text-danger(href="#")
                                i.bi.bi-box-arrow-right.me-2
                                | Đăng xuất
    
    .filter-search-sticky
        .filter-search-card
            .card-body.p-3
                .row.align-items-end.g-3
                    .col-lg-5
                        label.filter-label.mb-2
                            i.bi.bi-funnel.me-1
                            | Trạng thái
                        .btn-group.w-100(role="group")
                            +filter_status(filterStatus)
                    .col-lg-4
                        +search(keyword)
                
                //- Bộ lọc nâng cao
                hr.mt-3.mb-3
                form(action=`${admin}/products` method="GET")
                    //- Giữ lại keyword và trạng thái nếu có
                    if keyword
                        input(type="hidden" name="keyword" value=keyword)
                    - const activeStatus = filterStatus.find(item => item.class === 'active')
                    if activeStatus && activeStatus.status
                        input(type="hidden" name="trangthai" value=activeStatus.status)

                    .row.g-3
                        .col-md-2
                            label.form-label.small.fw-bold Xóa mềm
                            select.form-select.form-select-sm(name="deleted" onchange="this.form.submit()")
                                option(value="" selected=(!currentDeleted)) Chưa xóa
                                option(value="1" selected=(currentDeleted=='1')) Đã xóa (thùng rác)
                                option(value="all" selected=(currentDeleted=='all')) Tất cả
                        .col-md-2
                            label.form-label.small.fw-bold Sắp xếp
                            select.form-select.form-select-sm(name="sort" onchange="this.form.submit()")
                                option(value="ngaytao-desc" selected=(currentSort=='ngaytao-desc')) Mới nhất
                                option(value="ngaytao-asc" selected=(currentSort=='ngaytao-asc')) Cũ nhất
                                option(value="gia-desc" selected=(currentSort=='gia-desc')) Giá giảm dần
                                option(value="gia-asc" selected=(currentSort=='gia-asc')) Giá tăng dần
                                option(value="tensanpham-asc" selected=(currentSort=='tensanpham-asc')) Tên A-Z
                        .col-md-2
                            label.form-label.small.fw-bold Loại SP
                            select.form-select.form-select-sm(name="loaisanpham" onchange="this.form.submit()")
                                option(value="" selected=(!currentLoai)) Tất cả
                                option(value="ao" selected=(currentLoai=='ao')) Áo
                                option(value="quan" selected=(currentLoai=='quan')) Quần
                                option(value="vay" selected=(currentLoai=='vay')) Váy
                                option(value="phukien" selected=(currentLoai=='phukien')) Phụ kiện
                                option(value="giay" selected=(currentLoai=='giay')) Giày
                                option(value="tui" selected=(currentLoai=='tui')) Túi
                                option(value="aokhoac" selected=(currentLoai=='aokhoac')) Áo khoác
                        .col-md-2
                            label.form-label.small.fw-bold Giới tính
                            select.form-select.form-select-sm(name="gioitinh" onchange="this.form.submit()")
                                option(value="" selected=(!currentGioiTinh)) Tất cả
                                option(value="nam" selected=(currentGioiTinh=='nam')) Nam
                                option(value="nu" selected=(currentGioiTinh=='nu')) Nữ
                                option(value="unisex" selected=(currentGioiTinh=='unisex')) Unisex
                        .col-md-3
                            label.form-label.small.fw-bold Khoảng giá
                            .input-group.input-group-sm
                                input.form-control(type="number" name="priceMin" placeholder="Min" value=priceMin min="0")
                                span.input-group-text -
                                input.form-control(type="number" name="priceMax" placeholder="Max" value=priceMax min="0")
                        .col-md-3
                            label.form-label.small.fw-bold Ngày tạo
                            .input-group.input-group-sm
                                input.form-control(type="date" name="dateFrom" value=dateFrom)
                                span.input-group-text -
                                input.form-control(type="date" name="dateTo" value=dateTo)
                    .row.mt-2
                        .col-12.d-flex.justify-content-end.gap-2
                            a.btn.btn-outline-secondary.btn-sm(href=`${admin}/products`)
                                i.bi.bi-x-circle.me-1
                                | Xóa lọc
                            button.btn.btn-primary.btn-sm(type="submit")
                                i.bi.bi-funnel.me-1
                                | Lọc
    
    .dashboard-container
        if products && products.length
           
            .table-responsive.d-none.d-lg-block
                table.table.table-hover.align-middle.product-table
                    thead.table-light
                        tr
                            th(scope="col" style="width: 50px") STT
                            th(scope="col" style="width: 90px") Hình ảnh
                            th(scope="col") Tiêu đề
                            th(scope="col" style="width: 180px") Giá
                            th(scope="col" style="width: 90px") Tồn kho
                            th(scope="col" style="width: 110px") Ngày tạo
                            th(scope="col" style="width: 100px") Trạng thái
                            th(scope="col" style="width: 120px" class="text-end") Hành động
                    tbody
                        each product, idx in products
                            - const giaGoc = product.gia ? product.gia.toLocaleString('vi-VN') + '₫' : '—';
                            - const giamGia = product.phantramgiamgia || 0;
                            - const giaKhuyenMai = giamGia > 0 ? Math.round(product.gia * (100 - giamGia) / 100).toLocaleString('vi-VN') + '₫' : null;
                            - const status = (product.trangthai || '').toLowerCase();
                            - const isActive = status === 'dangban' || status === 'active' || status === 'đang bán';
                            - const imgSrc = product.displayImage || product.hinhanh || '/images/shopping.png';
                            - const ngayTao = product.ngaytao ? new Date(product.ngaytao).toLocaleDateString('vi-VN') : '—';
                            - const tonKho = (product.tonkho !== undefined && product.tonkho !== null) ? product.tonkho : (product.soluongton || 0);
                            tr
                                td.text-muted #{idx + 1}
                                td
                                    img.product-img(src=imgSrc, alt=product.tensanpham || 'Hình sản phẩm')
                                td
                                    .fw-semibold #{product.tensanpham || '—'}
                                    if product.bienthe && product.bienthe.length
                                        small.text-muted #{product.bienthe.length} biến thể
                                td
                                    if giamGia > 0
                                        .d-flex.flex-column
                                            span.text-decoration-line-through.text-muted.small #{giaGoc}
                                            span.fw-bold.text-danger #{giaKhuyenMai}
                                            span.badge.bg-warning.text-dark.mt-1(style="width: fit-content") -#{giamGia}%
                                    else
                                        span.fw-semibold.text-primary #{giaGoc}
                                td
                                    if tonKho > 0
                                        span.fw-semibold #{tonKho}
                                    else
                                        span.badge.bg-secondary.rounded-pill Hết
                                td
                                    small.text-muted
                                        i.bi.bi-calendar.me-1
                                        | #{ngayTao}
                                td
                                    if isActive
                                        span.badge.bg-success.rounded-pill Đang bán
                                    else
                                        span.badge.bg-danger.rounded-pill Ngừng bán
                                td.text-end
                                    .btn-group.btn-group-sm
                                        a.btn.btn-outline-warning(href=`${admin}/products/${product._id}/edit`, title="Sửa")
                                            i.bi.bi-pencil
                                        if product.daxoa
                                            form(method="POST" action=`${admin}/products/${product._id}/restore` onsubmit="return confirm('Khôi phục sản phẩm này?')")
                                                button.btn.btn-outline-success(type="submit" title="Khôi phục")
                                                    i.bi.bi-arrow-counterclockwise
                                            form(method="POST" action=`${admin}/products/${product._id}/hard-delete` onsubmit="return confirm('Xóa vĩnh viễn sản phẩm này? Hành động không thể hoàn tác!')")
                                                button.btn.btn-danger(type="submit" title="Xóa vĩnh viễn")
                                                    i.bi.bi-x-octagon
                                        else
                                            a.btn.btn-outline-danger(href=`${admin}/products/${product._id}/delete`, title="Xóa" onclick="return confirmDelete('Bạn có chắc chắn muốn xóa?')")
                                                i.bi.bi-trash
            
            
            .row.g-3.d-lg-none
                each product, idx in products
                    - const price = product.giamoiText || product.giaText || (product.gia ? product.gia.toLocaleString('vi-VN') + '₫' : '—');
                    - const status = (product.trangthai || '').toLowerCase();
                    - const isActive = status === 'dangban' || status === 'active' || status === 'đang bán';
                    - const imgSrc = product.displayImage || product.hinhanh || '/images/shopping.png';
                    .col-12.col-sm-6.col-md-4
                        .card.product-card.h-100
                            img.card-img-top.product-card-img(src=imgSrc, alt=product.tensanpham || 'Hình sản phẩm')
                            .card-body
                                h6.card-title.mb-1 #{product.tensanpham || '—'}
                                if product.bienthe && product.bienthe.length
                                    small.text-muted.d-block.mb-2 #{product.bienthe.length} biến thể
                                .d-flex.justify-content-between.align-items-center.mb-2
                                    span.fw-bold.text-primary #{price}
                                    if isActive
                                        span.badge.bg-success.rounded-pill Đang bán
                                    else
                                        span.badge.bg-danger.rounded-pill Ngừng
                                - const tonKhoMobile = (product.tonkho !== undefined && product.tonkho !== null) ? product.tonkho : (product.soluongton || 0);
                                small.text-muted.d-block Tồn kho: #{tonKhoMobile}
                            .card-footer.bg-transparent.border-0.pt-0
                                .d-flex.gap-2
                                    a.btn.btn-sm.btn-warning.flex-fill(href=`${admin}/products/${product._id}/edit`)
                                        i.bi.bi-pencil.me-1
                                        | Sửa
                                    if product.daxoa
                                        form.flex-fill(method="POST" action=`${admin}/products/${product._id}/restore` onsubmit="return confirm('Khôi phục sản phẩm này?')")
                                            button.btn.btn-sm.btn-success.w-100(type="submit")
                                                i.bi.bi-arrow-counterclockwise.me-1
                                                | Khôi phục
                                        form.flex-fill(method="POST" action=`${admin}/products/${product._id}/hard-delete` onsubmit="return confirm('Xóa vĩnh viễn sản phẩm này? Hành động không thể hoàn tác!')")
                                            button.btn.btn-sm.btn-danger.w-100(type="submit")
                                                i.bi.bi-x-octagon.me-1
                                                | Xóa vĩnh viễn
                                    else
                                        a.btn.btn-sm.btn-danger.flex-fill(href=`${admin}/products/${product._id}/delete` onclick="return confirmDelete('Bạn có chắc chắn muốn xóa?')")
                                            i.bi.bi-trash.me-1
                                            | Xóa
            
           
            +page()
        else
            .empty-state.text-center.py-5
                .empty-state-icon.mb-4
                    i.bi.bi-inbox.display-1.text-muted
                .empty-state-content
                    h4.text-muted Không tìm thấy sản phẩm
                    p.text-muted.mb-4 Không có sản phẩm nào phù hợp với tiêu chí tìm kiếm của bạn.
                    .d-flex.justify-content-center.gap-2
                        a.btn.btn-outline-secondary(href=`${admin}/products`)
                            i.bi.bi-arrow-counterclockwise.me-1
                            | Xóa bộ lọc
                        a.btn.btn-primary(href=`${admin}/products/create`)
                            i.bi.bi-plus-lg.me-1
                            | Thêm sản phẩm mới

block scripts
    script(src="/admin/js/products.js")
    script.
        (function () {
            if (window.FilterAutoSubmit && typeof window.FilterAutoSubmit.attachOnReady === 'function') {
                window.FilterAutoSubmit.attachOnReady('.filter-search-card form[action$="/products"]', {
                    inputSelectors: [
                        'input[name="priceMin"]',
                        'input[name="priceMax"]',
                        'input[name="dateFrom"]',
                        'input[name="dateTo"]'
                    ],
                    inputDebounceMs: 800,
                    // keyword is handled by #form-search in /admin/js/admin.js
                    keywordSelector: null
                });
            }
        })();
